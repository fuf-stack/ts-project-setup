name: release-please

permissions:
  contents: write
  pull-requests: write
  repository-projects: read # needed for 'gh pr edit' https://github.com/cli/cli/issues/6274
  id-token: write # Required for OIDC trusted publishing with npm

on:
  push:
    branches:
      - main

# Ensure only one release workflow runs at a time
# Queue new runs and wait for in-progress release-please workflow to complete
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.RELEASE_PLEASE_GITHUB_TOKEN }}

      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
        if: steps.release.outputs.releases_created  == 'true'

      - name: Setup project
        uses: ./.github/actions/setup-project
        if: steps.release.outputs.releases_created  == 'true'

      - name: Publish to npm
        run: |
          # Ensure npm 11.5.1 or later for trusted publishing (OIDC)
          npm install -g npm@latest
          # Use npm publish via Lerna for trusted publishing support
          # pnpm doesn't support npm's trusted publishing (OIDC) yet, so we use npm directly
          # Lerna detects changed packages and publishes them using npm
          npx lerna publish from-package --yes --no-verify-access
        if: steps.release.outputs.releases_created  == 'true'
        # Note: If you have private npm dependencies, you may need NODE_AUTH_TOKEN
        # for installing dependencies only (not for publishing)
        # env:
        #   NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # update other conflicting prs after package merge
  # see: https://github.com/googleapis/release-please/issues/1870#issuecomment-1748390833
  check-conflicting-prs:
    runs-on: ubuntu-latest
    needs: release-please
    if: needs.release-please.outputs.releases_created == 'true'
    outputs:
      need_rebase: ${{ steps.check-pending-prs.outputs.need_rebase }}
    steps:
      - name: Get pending PRs
        id: check-pending-prs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          pending_prs=$(gh pr list --repo "$REPO" --label "autorelease: pending" --state open --json number --jq '.[].number')
          need_rebase=""

          if [[ -n "$pending_prs" ]]; then
            for pr_num in $pending_prs; do
              echo "Checking pr: $pr_num"
              mergeable=$(gh pr view --repo "$REPO" "$pr_num" --json mergeable --jq '.mergeable')
              echo "mergeable status: $mergeable"
              if [[ "$mergeable" != "MERGEABLE" ]]; then
                echo "pr: $pr_num is not MERGEABLE."
                echo "removing 'autorelease: pending' label from pr: $pr_num"
                gh pr edit --repo "$REPO" "$pr_num" --remove-label "autorelease: pending"
                need_rebase=true
              fi
            done
          else
              echo "No pending PRs found."
              exit 0
          fi

          if [[ -n "$need_rebase" ]]; then
            echo "not MERGEABLE status PRs found."
            echo "need_rebase=$need_rebase"
            echo "need_rebase=$need_rebase" >> "$GITHUB_OUTPUT"
          else
            echo "All pending PRs are MERGEABLE."
          fi

  release-please-rebase:
    needs: check-conflicting-prs
    runs-on: ubuntu-latest
    if: needs.check-conflicting-prs.outputs.need_rebase == 'true'
    steps:
      - uses: googleapis/release-please-action@v4
